{% extends "base.html" %}
{% block title %}{{ meeting.title }} - Agendas{% endblock %}
{% block extra_css %}
.notes-pane { min-height: 320px; }
.notes-pane textarea { font-size: 1.05rem; }
.action-item-row { border-left: 3px solid var(--accent); padding-left: 0.75rem; margin-bottom: 0.5rem; font-size: 1.05rem; }
.action-item-row strong { font-size: 1.05rem; }
{% endblock %}
{% block content %}
<div class="container-fluid px-0">
  <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
    <a href="{{ url_for('agendas_list') }}" class="btn btn-outline-secondary btn-sm">← Agendas</a>
    <h2 class="mb-0 fw-bold">{{ meeting.title or 'Meeting' }}</h2>
    <span class="text-muted">{{ meeting.date or '—' }}{% if meeting.attendees %} · {{ meeting.attendees }}{% endif %}</span>
    <div class="ms-auto d-flex gap-2">
      <a href="/google_docs/connect" class="btn btn-outline-secondary btn-sm align-self-center">Connect Google</a>
      <button class="btn btn-outline-primary btn-sm" id="import-gdoc-btn">Import from Google Doc</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card notes-pane">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Notes</span>
          <button type="button" class="btn btn-sm btn-outline-primary" id="save-notes-btn">Save</button>
        </div>
        <div class="card-body">
          <textarea id="meeting-notes" class="form-control font-monospace" rows="14" placeholder="Paste or type meeting agenda and notes here...">{{ meeting.notes or '' }}</textarea>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card notes-pane">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span class="fw-semibold">Action items</span>
          <div>
            <button type="button" class="btn btn-sm btn-success me-1" id="extract-action-items-btn">Extract from notes</button>
            <a href="{{ url_for('action_items_full') }}" class="btn btn-sm btn-outline-secondary">View all</a>
          </div>
        </div>
        <div class="card-body">
          <div id="action-items-list">
            {% for item in (meeting.action_items or []) %}
            <div class="action-item-row d-flex justify-content-between align-items-start bg-light rounded px-2 py-2" data-index="{{ loop.index0 }}">
              <div>
                <strong>{{ item.text }}</strong>
                {% if item.due_date %}<div class="small text-muted">Due: {{ item.due_date }}</div>{% endif %}
                {% if item.owner %}<div class="small">Assignee: {{ item.owner }}</div>{% endif %}
              </div>
              <span class="badge bg-{{ 'success' if item.status == 'done' else 'primary' }}">{{ item.status }}</span>
            </div>
            {% endfor %}
            {% if not meeting.action_items or meeting.action_items|length == 0 %}
            <p class="text-muted small mb-0" id="no-items-msg">No action items. Type notes on the left and click "Extract from notes" to pull out to-dos.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Import single Google Doc modal -->
<div class="modal fade" id="importGDocModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import from Google Doc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Google Doc ID</label>
          <input type="text" id="gdoc-id" class="form-control" placeholder="Enter Google Doc ID or URL">
        </div>
        <div id="gdoc-import-msg" style="display:none;" class="text-muted small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="gdoc-import-submit">Import into meeting</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var meetingId = '{{ meeting.id }}';

  document.getElementById('save-notes-btn').onclick = function() {
    var notes = document.getElementById('meeting-notes').value;
    fetch('/api/meetings/' + meetingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notes: notes })
    })
    .then(function(r) { return r.json(); })
    .then(function(j) {
      if (j.success) { alert('Notes saved.'); }
      else alert('Failed to save');
    })
    .catch(function() { alert('Error'); });
  };

  document.getElementById('extract-action-items-btn').onclick = function() {
    var btn = this;
    btn.disabled = true;
    btn.textContent = 'Extracting...';
    fetch('/api/meetings/' + meetingId + '/extract_action_items', { method: 'POST' })
    .then(function(r) { return r.json(); })
    .then(function(j) {
      btn.disabled = false;
      btn.textContent = 'Extract from notes';
      if (j.success) location.reload();
      else alert(j.error || 'Extraction failed');
    })
    .catch(function() {
      btn.disabled = false;
      btn.textContent = 'Extract from notes';
      alert('Error');
    });
  };

  // Import Google Doc into this meeting
  var importBtn = document.getElementById('import-gdoc-btn');
  if (importBtn) importBtn.addEventListener('click', function() { new bootstrap.Modal(document.getElementById('importGDocModal')).show(); });
  var importSubmit = document.getElementById('gdoc-import-submit');
  if (importSubmit) importSubmit.addEventListener('click', function() {
    var raw = document.getElementById('gdoc-id').value.trim();
    if (!raw) { alert('Please enter a Google Doc ID or URL'); return; }
    // attempt to extract doc id from url
    var docId = raw;
    var m = raw.match(/[-\w]{25,}/);
    if (m) docId = m[0];
    var msg = document.getElementById('gdoc-import-msg'); msg.style.display='block'; msg.textContent='Importing...';
    fetch('/api/google_docs/extract_doc', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({doc_id: docId, meeting_id: meetingId}) })
      .then(r=>r.json()).then(function(j){
        if (j.success) { msg.textContent = 'Imported ' + (j.count||0) + ' action items — reloading'; setTimeout(()=>location.reload(),800); }
        else { msg.textContent = j.error || 'Import failed'; }
      }).catch(function(){ msg.textContent='Import failed'; });
  });
})();
</script>
{% endblock %}
