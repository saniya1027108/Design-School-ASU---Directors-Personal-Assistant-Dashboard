{% extends "base.html" %}
{% block title %}Agendas - Personal Assistant{% endblock %}
{% block main_content_class %}agendas-full-width{% endblock %}
{% block extra_css %}
.agenda-card .card-title { font-size: 1.2rem; }
.agenda-card .card-text { font-size: 1rem; }
.agenda-section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-neutral); }
/* Drive agendas: gallery of category boxes (3 per row) + folder view */
.drive-gallery { display: block; }
.drive-gallery.hidden { display: none !important; }
.drive-category-box { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; padding: 2.25rem 1.75rem; border: 2px solid var(--border-neutral); border-radius: 14px; background: var(--card-bg); box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; text-decoration: none; color: inherit; }
.drive-category-box:hover { border-color: var(--accent); box-shadow: var(--shadow-md); background: var(--accent-light); transform: translateY(-2px); }
.drive-category-box .category-icon { width: 60px; height: 60px; margin-bottom: 0.9rem; color: var(--accent); flex-shrink: 0; }
.drive-category-box .category-name { font-size: 1.2rem; font-weight: 600; text-align: center; margin-bottom: 0.35rem; line-height: 1.3; }
.drive-category-box .category-meta { font-size: 0.9rem; color: var(--text-muted); text-align: center; }
.drive-folder-view { display: none; }
.drive-folder-view.active { display: block; }
.drive-back-bar { margin-bottom: 1.25rem; }
/* Person/folder cards = large gallery boxes (2 per row on lg for bigger size) */
.drive-person-card { border: 2px solid var(--card-border); border-radius: 14px; padding: 1.75rem; min-height: 320px; background: var(--card-bg); box-shadow: var(--shadow-sm); transition: all 0.2s; height: 100%; }
.drive-person-card:hover { box-shadow: var(--shadow-md); border-color: var(--accent-soft); }
.drive-person-card-header { font-size: 1.35rem; font-weight: 600; margin-bottom: 1.25rem; padding-bottom: 0.85rem; border-bottom: 2px solid var(--accent-soft); color: var(--accent); }
/* Docs inside person card = grid of boxes (3 per row for better use of space) */
.drive-docs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
@media (max-width: 992px) { .drive-docs-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 576px) { .drive-docs-grid { grid-template-columns: 1fr; } }
.drive-doc-item { background: var(--surface-soft); border: 1px solid var(--border-neutral); border-radius: 10px; padding: 1rem; margin: 0; }
.drive-doc-item .drive-doc-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; line-height: 1.3; }
.drive-doc-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; }
.drive-doc-actions .btn-sm { font-size: 0.8rem; padding: 0.35rem 0.6rem; }
/* Action items as checkboxes */
.action-items-checklist { padding: 0.75rem; background: var(--accent-light); border-radius: 8px; margin-top: 0.5rem; }
.action-item-check { padding: 0.5rem 0; border-bottom: 1px solid var(--border-neutral); }
.action-item-check:last-child { border-bottom: none; }
.action-item-check .form-check-input { cursor: pointer; margin-top: 0.15rem; }
.action-item-check .form-check-label { cursor: pointer; font-size: 0.9rem; line-height: 1.4; }
.action-item-check .form-check-input:checked ~ .form-check-label { text-decoration: line-through; color: var(--text-muted); }
{% endblock %}
{% block content %}
<div class="container-fluid px-0 w-100">
  <h2 class="mb-4 fw-bold">Agendas</h2>
  <div class="mb-4 p-3 rounded" style="background: var(--accent-light); border: 1px solid var(--border-neutral);">
    <h6 class="mb-2">Import from Google Drive</h6>
    <p class="text-muted small mb-2">Extract action items from 2026 Google Docs. Structure: <strong>Root</strong> ‚Üí <strong>Category folders</strong> (e.g. "Staff Meetings", "Projects") ‚Üí <strong>Person/project folders</strong> ‚Üí <strong>2026 docs</strong>. Only docs with "2026" in the title are extracted.</p>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <button class="btn btn-primary" id="import-gdocs-folder-btn">Import from Drive folder‚Ä¶</button>
      <a href="{{ url_for('calendar_connect') }}" class="btn btn-outline-secondary">Connect Google (Calendar + Drive)</a>
    </div>
  </div>

  <!-- From Google Drive: Gallery of category boxes (3 per row); click opens folder view with person cards -->
  {% if drive_agendas and drive_agendas.get('by_folder') %}
  <section class="mb-5">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="mb-0 fw-bold">Google Drive Agendas (2026)</h2>
      <span class="text-muted small">Last import: {{ drive_agendas.get('last_import', '')[:10] or '‚Äî' }}</span>
    </div>
    
    {% set first_value = drive_agendas.by_folder.values()|first %}
    {% if first_value is mapping %}
      {# Gallery: big category boxes (3 per row); click opens folder view #}
      <div id="drive-gallery" class="drive-gallery">
        <p class="text-muted small mb-3">Click a category to open its agendas.</p>
        <div class="row g-4">
          {% for category_name, person_folders in drive_agendas.by_folder.items() %}
          {% set ns = namespace(total_docs=0) %}
          {% for doclist in person_folders.values() %}{% set ns.total_docs = ns.total_docs + doclist|length %}{% endfor %}
          <div class="col-12 col-md-6 col-lg-4">
            <a href="javascript:void(0)" class="drive-category-box text-decoration-none" data-category-id="cat-{{ loop.index }}" role="button">
              <svg class="category-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
              <span class="category-name">{{ category_name }}</span>
              <span class="category-meta">{{ person_folders|length }} folder{{ 's' if person_folders|length != 1 else '' }} ¬∑ {{ ns.total_docs }} doc{{ 's' if ns.total_docs != 1 else '' }}</span>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Folder views: one per category (person cards, 3 per row); shown when category box is clicked -->
      {% for category_name, person_folders in drive_agendas.by_folder.items() %}
      <div id="cat-{{ loop.index }}" class="drive-folder-view" data-category-name="{{ category_name }}">
        <div class="drive-back-bar">
          <button type="button" class="btn btn-outline-secondary btn-sm drive-back-btn" aria-label="Back to categories">
            ‚Üê Back to categories
          </button>
        </div>
        <h3 class="mb-4 fw-bold">{{ category_name }}</h3>
        <div class="row g-4">
          {% for person_name, docs in person_folders.items() %}
          <div class="col-12 col-md-6 col-lg-6">
            <div class="drive-person-card">
              <div class="drive-person-card-header">
                <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 0.4rem;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                {{ person_name }}
              </div>
              
              {% if docs %}
                <div class="drive-docs-grid">
                {% for doc in docs %}
                <div class="drive-doc-item">
                  <div class="drive-doc-title">
                    <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 0.3rem; color: var(--color-blue-accent);" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
                    {{ doc.doc_name or 'Untitled' }}
                  </div>
                  <div class="drive-doc-actions">
                    <a href="{{ doc.doc_link or '#' }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary">üìÑ Notes</a>
                    <a href="{{ url_for('agenda_drive_action_items', doc_id=doc.doc_id) }}" class="btn btn-sm btn-outline-primary">
                      ‚úì Action items ({{ doc.get('items', [])|length }})
                    </a>
                  </div>
                </div>
                {% endfor %}
                </div>
              {% else %}
              <p class="text-muted small mb-0">No documents found.</p>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    
    <script>
    (function() {
      var gallery = document.getElementById('drive-gallery');
      if (!gallery) return;
      var categoryBoxes = gallery.querySelectorAll('.drive-category-box');
      var folderViews = document.querySelectorAll('.drive-folder-view');
      var backBtns = document.querySelectorAll('.drive-back-btn');
      function showGallery() {
        gallery.classList.remove('hidden');
        folderViews.forEach(function(v) { v.classList.remove('active'); });
      }
      function showFolderView(id) {
        gallery.classList.add('hidden');
        folderViews.forEach(function(v) {
          v.classList.toggle('active', v.id === id);
        });
      }
      categoryBoxes.forEach(function(box) {
        box.addEventListener('click', function() {
          var id = box.getAttribute('data-category-id');
          if (id) showFolderView(id);
        });
      });
      backBtns.forEach(function(btn) {
        btn.addEventListener('click', showGallery);
      });
    })();
    </script>
    
    {% else %}
      {# Old 2-level structure: needs re-import #}
      <div class="alert alert-warning">
        <h5>‚ö†Ô∏è Old Data Format Detected</h5>
        <p class="mb-2">Your saved Drive agendas use an older format. The new version supports:</p>
        <ul class="mb-3">
          <li><strong>3-level folder structure</strong>: Category folders ‚Üí Person folders ‚Üí 2026 docs</li>
          <li><strong>Tabbed categories</strong> (Staff Meetings, Projects, etc.)</li>
          <li><strong>Card grid layout</strong> (3 per row)</li>
          <li><strong>Checkbox to-do lists</strong> for action items</li>
        </ul>
        <p class="mb-0">
          <strong>To use the new interface:</strong> Click <strong>"Import from Drive folder‚Ä¶"</strong> above and run the extraction again. 
          The new data will replace this old format.
        </p>
      </div>
    {% endif %}
  </section>
  {% endif %}

  <!-- Staff agendas (1:1) -->
  <section class="mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h3 class="agenda-section-title mb-0">Staff agendas (1:1)</h3>
      <button type="button" class="btn btn-primary btn-add-meeting" data-agenda-type="staff">+ New meeting</button>
    </div>
    <div class="row g-3">
      {% for m in staff_meetings %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 agenda-card">
          <div class="card-body">
            <h5 class="card-title">{{ m.title or 'Untitled' }}</h5>
            <p class="text-muted mb-1" style="font-size:0.95rem;">{{ m.date or '‚Äî' }}{% if m.attendees %} ¬∑ {{ m.attendees }}{% endif %}</p>
            <p class="card-text text-truncate" style="max-height: 3em;">{{ m.notes or 'No notes yet' }}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <span class="badge bg-secondary">{{ (m.action_items or [])|length }} action items</span>
              <a href="{{ url_for('agenda_detail', meeting_id=m.id) }}" class="btn btn-sm btn-outline-primary">Notes & actions</a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% if not staff_meetings %}
      <div class="col-12">
        <div class="card agenda-empty">
          <div class="card-body text-center py-4">
            <p class="text-muted mb-2">No staff meetings yet.</p>
            <button type="button" class="btn btn-outline-primary btn-add-meeting" data-agenda-type="staff">+ Add staff meeting</button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Project agendas -->
  <section>
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h3 class="agenda-section-title mb-0">Project agendas</h3>
      <button type="button" class="btn btn-primary btn-add-meeting" data-agenda-type="project">+ New meeting</button>
    </div>
    <div class="row g-3">
      {% for m in project_meetings %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 agenda-card">
          <div class="card-body">
            <h5 class="card-title">{{ m.title or 'Untitled' }}</h5>
            <p class="text-muted mb-1" style="font-size:0.95rem;">{{ m.date or '‚Äî' }}{% if m.attendees %} ¬∑ {{ m.attendees }}{% endif %}</p>
            <p class="card-text text-truncate" style="max-height: 3em;">{{ m.notes or 'No notes yet' }}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <span class="badge bg-secondary">{{ (m.action_items or [])|length }} action items</span>
              <a href="{{ url_for('agenda_detail', meeting_id=m.id) }}" class="btn btn-sm btn-outline-primary">Notes & actions</a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% if not project_meetings %}
      <div class="col-12">
        <div class="card agenda-empty">
          <div class="card-body text-center py-4">
            <p class="text-muted mb-2">No project meetings yet.</p>
            <button type="button" class="btn btn-outline-primary btn-add-meeting" data-agenda-type="project">+ Add project meeting</button>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </section>
</div>

<!-- Import Google Drive folder modal -->
<div class="modal fade" id="importGDocsFolderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import from Google Drive (Agendas folder)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Drive folder ID (root Agendas folder)</label>
          <input type="text" id="gdocs-folder-id" class="form-control" placeholder="e.g. 1ABC... from the folder URL in Drive">
          <small class="text-muted">From the folder URL: drive.google.com/drive/folders/<strong>FOLDER_ID</strong></small>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="gdocs-merge-check" checked>
          <label class="form-check-label" for="gdocs-merge-check">Add extracted action items to Action Items dashboard</label>
        </div>
        <div id="gdocs-import-msg" style="display:none;" class="mb-2"></div>
        <div id="gdocs-import-result" style="display:none;" class="border rounded p-3 bg-light"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="gdocs-import-submit">Extract from Drive</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newMeetingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New meeting</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="new-meeting-agenda-type" value="staff">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" id="new-meeting-title" class="form-control" placeholder="e.g. 1:1 with Mireille / 2026 DP">
        </div>
        <div class="mb-3">
          <label class="form-label">Date</label>
          <input type="date" id="new-meeting-date" class="form-control">
        </div>
        <div class="mb-3">
          <label class="form-label">Attendees</label>
          <input type="text" id="new-meeting-attendees" class="form-control" placeholder="Names">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="create-meeting-btn">Create</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var d = new Date();
  document.getElementById('new-meeting-date').value = d.toISOString().slice(0, 10);

  document.querySelectorAll('.btn-add-meeting').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var type = this.getAttribute('data-agenda-type') || 'staff';
      document.getElementById('new-meeting-agenda-type').value = type;
      new bootstrap.Modal(document.getElementById('newMeetingModal')).show();
    });
  });

  document.getElementById('create-meeting-btn').onclick = function() {
    var title = document.getElementById('new-meeting-title').value.trim() || 'Untitled meeting';
    var date = document.getElementById('new-meeting-date').value;
    var attendees = document.getElementById('new-meeting-attendees').value.trim();
    var agendaType = document.getElementById('new-meeting-agenda-type').value || 'staff';
    fetch('/api/meetings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: title, date: date, attendees: attendees, agenda_type: agendaType, notes: '', action_items: [] })
    })
    .then(function(r) { return r.json(); })
    .then(function(j) {
      if (j.success && j.meeting) window.location.href = '/agendas/' + j.meeting.id;
      else alert('Failed to create meeting');
    })
    .catch(function() { alert('Error'); });
  };
  // Import from Google Drive (folder structure = people/projects)
  var importBtn = document.getElementById('import-gdocs-folder-btn');
  if (importBtn) {
    importBtn.addEventListener('click', function() {
      document.getElementById('gdocs-import-result').style.display = 'none';
      document.getElementById('gdocs-import-result').innerHTML = '';
      new bootstrap.Modal(document.getElementById('importGDocsFolderModal')).show();
    });
  }
  var submitImport = document.getElementById('gdocs-import-submit');
  if (submitImport) {
    submitImport.addEventListener('click', function() {
      var fid = document.getElementById('gdocs-folder-id').value.trim();
      if (!fid) { alert('Please enter a folder ID'); return; }
      var merge = document.getElementById('gdocs-merge-check').checked;
      var msg = document.getElementById('gdocs-import-msg');
      var resultDiv = document.getElementById('gdocs-import-result');
      msg.style.display = 'block';
      msg.className = 'text-muted';
      msg.textContent = 'Reading Drive folder and extracting action items‚Ä¶';
      resultDiv.style.display = 'none';
      resultDiv.innerHTML = '';
      fetch('/api/drive/agendas/extract', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ folder_id: fid, merge: merge })
      })
      .then(function(r) {
        if (!r.ok) {
          return r.text().then(function(t) {
            throw new Error('Server returned ' + r.status + (r.status === 401 ? ' (not logged in ‚Äì try refreshing and logging in again)' : '') + (t && t.length < 150 ? ': ' + t : ''));
          });
        }
        return r.json();
      })
      .then(function(j) {
        if (j.success) {
          var stats = j.stats || {};
          var totalDocs = stats.total_docs_processed || 0;
          var categoryCount = stats.category_folders || 0;
          msg.className = 'text-success';
          msg.textContent = 'Extracted ' + (j.count || 0) + ' action items from ' + totalDocs + ' 2026 doc(s) in ' + categoryCount + ' category folder(s).' + (merge ? ' Added to Action Items dashboard.' : '');
          if (totalDocs === 0) {
            msg.className = 'text-warning';
            msg.textContent = 'No 2026 Google Docs found. Make sure your folder structure is: Root ‚Üí Category folders (e.g. "Staff Meetings") ‚Üí Person folders ‚Üí Docs with "2026" in the title.';
          }
          var byFolder = j.by_folder || {};
          var html = '<strong>By Category</strong><ul class="mb-0 mt-2">';
          for (var categoryName in byFolder) {
            var personFolders = byFolder[categoryName];
            var catTotal = 0;
            var catDocs = 0;
            for (var personName in personFolders) {
              var docs = personFolders[personName];
              catDocs += docs.length;
              docs.forEach(function(d) { catTotal += (d.items && d.items.length) || 0; });
            }
            html += '<li><strong>' + categoryName + '</strong>: ' + Object.keys(personFolders).length + ' person/project folder(s), ' + catDocs + ' doc(s), ' + catTotal + ' action item(s)';
            html += '<ul class="small">';
            for (var personName in personFolders) {
              var docs = personFolders[personName];
              var total = 0;
              docs.forEach(function(d) { total += (d.items && d.items.length) || 0; });
              html += '<li><strong>' + personName + '</strong>: ' + docs.length + ' doc(s), ' + total + ' items';
              if (docs.length && docs.some(function(d) { return d.error; })) {
                html += ' <span class="text-danger">(some docs had errors)</span>';
              }
              html += '</li>';
            }
            html += '</ul></li>';
          }
          html += '</ul>';
          resultDiv.innerHTML = html;
          resultDiv.style.display = 'block';
          // Reload so the Agendas tab shows the imported docs and action items
          if (j.success) setTimeout(function() { location.reload(); }, 1500);
        } else {
          msg.className = 'text-danger';
          msg.textContent = j.error || 'Import failed';
        }
      })
      .catch(function(e) {
        msg.className = 'text-danger';
        msg.textContent = e && e.message ? e.message : 'Request failed. Check that you are logged in, the server is running in your terminal, and Google Drive is connected (Connect Google).';
      });
    });
  }
})();
</script>
{% endblock %}
